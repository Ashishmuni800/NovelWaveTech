<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Novel Wave Tech — Eco Logo with Login</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <!-- Bootstrap & Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="stylesheet" href="~/css/Loginlayout.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/LogoCSS.css" asp-append-version="true" />
</head>

<body class="light">
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="toast position-fixed bottom-0 end-0 m-4" role="alert"
             aria-live="assertive" aria-atomic="true"
             data-bs-delay="5000" data-bs-autohide="true" style="z-index: 1055;">
            <div class="toast-header bg-success text-white">
                <strong class="me-auto">Success</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">@TempData["SuccessMessage"]</div>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="toast position-fixed bottom-0 end-0 m-4" role="alert"
             aria-live="assertive" aria-atomic="true"
             data-bs-delay="5000" data-bs-autohide="true" style="z-index: 1055;">
            <div class="toast-header bg-danger text-white">
                <strong class="me-auto">Error</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">@TempData["ErrorMessage"]</div>
        </div>
    }
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12 col-sm-10 col-md-6 col-lg-6">
                <div class="wrap">
                    <div class="card stage">
                        <div class="logo-grid">
                            <svg class="mark" viewBox="0 0 160 160">
                                <circle cx="80" cy="80" r="62" fill="none" stroke="var(--ink)" stroke-width="2" />
                                <g class="leaf">
                                    <path d="M95 30c-22 8-38 23-47 45 10-5 24-6 34-2 10 4 18 12 22 22 7-22 4-47-9-65z" fill="var(--eco)" />
                                </g>
                                <g class="wave">
                                    <path d="M36 104c18 0 24-14 40-14 18 0 20 14 38 14 12 0 20-6 24-14-6 24-26 40-58 40-30 0-52-15-58-38 5 7 10 12 14 12z" fill="var(--ocean)" />
                                </g>
                            </svg>
                            <div class="wordmark">
                                <div class="brand"><span class="novel">Novel</span><span class="wave">Wave</span><span class="tech">Tech</span></div>
                                @* <div class="tag">Eco‑friendly innovation — clean energy, clean code.</div>
                                <div class="controls">
                                    <button id="toggleTheme">Toggle theme</button>
                                </div> *@
                            </div>
                        </div>
                    </div>

                    <div class="card shadow-sm mb-5">
                        <div class="card-header text-center bg-primary text-white">
                            <h4 class="mb-0"><i class="fa fa-sign-in-alt me-2"></i>Sign In</h4>
                        </div>
                        <div class="card-body p-4">
                            <form id="loginForm" autocomplete="off">
                                <div class="mb-3 position-relative">
                                    <label for="email" class="form-label">Email Address</label>
                                    <i class="fa fa-envelope position-absolute text-muted" style="top: 38px; left: 10px;"></i>
                                    <input type="email" class="form-control ps-4" id="email" name="email" required />
                                </div>
                                <div class="mb-3 position-relative">
                                    <label for="password" class="form-label">Password</label>
                                    <i class="fa fa-lock position-absolute text-muted" style="top: 38px; left: 10px;"></i>
                                    <input type="password" class="form-control ps-4" id="password" name="password" required />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Captcha</label>
                                    <div class="input-group">
                                        <img id="img-captcha" src="/Home/Captcha" alt="captcha" style="height: 40px;" />
                                        <button class="btn btn-outline-secondary" type="button" id="captchaRefresh"><i class="fa fa-sync-alt"></i></button>
                                    </div>
                                    <input type="text" class="form-control mt-2" id="CaptchaCode" name="CaptchaCode" maxlength="6" placeholder="Enter Captcha" required />
                                </div>
                                <input type="hidden" id="Id" name="Id" />
                                <div class="mb-3">
                                    <button type="submit" class="btn btn-primary w-100"><i class="fa fa-key me-2"></i>Sign In</button>
                                    <div class="text-center mt-3">
                                        <p>Already have a QR Code account? <a href="/Home/QRScan">Sign In with QR Code</a></p>
                                        <p>Don't have an account? <a href="/Home/Register">Sign Up here</a></p>
                                    </div>
                                </div>
                                <div id="statusMessageDisplay" class="text-center mt-3"></div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var toastElList = [].slice.call(document.querySelectorAll('.toast'))
            toastElList.forEach(function (toastEl) {
                var toast = new bootstrap.Toast(toastEl)
                toast.show()
            })
        });

        // const root = document.body;
        // const toggleBtn = document.getElementById('toggleTheme');
        // toggleBtn.addEventListener('click', ()=>{
        //   root.classList.toggle('light');
        // });

        // // Download helpers
        // const svgEl = document.querySelector('.mark');

        // function inlineSVG() {
        //   const clone = svgEl.cloneNode(true);
        //   clone.removeAttribute('class');
        //   clone.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
        //   return new XMLSerializer().serializeToString(clone);
        // }

        // document.getElementById('downloadSVG').addEventListener('click', () => {
        //   const data = inlineSVG();
        //   const blob = new Blob([data], { type: 'image/svg+xml;charset=utf-8' });
        //   const url = URL.createObjectURL(blob);
        //   const a = document.createElement('a');
        //   a.href = url; a.download = 'novel-wave-tech-logo.svg';
        //   document.body.appendChild(a); a.click(); a.remove();
        //   URL.revokeObjectURL(url);
        // });

        // document.getElementById('downloadPNG').addEventListener('click', () => {
        //   const data = inlineSVG();
        //   const img = new Image();
        //   const scale = 4; // 4x for crisp export
        //   const canvas = document.createElement('canvas');
        //   const size = 160 * scale;
        //   canvas.width = size; canvas.height = size;
        //   const ctx = canvas.getContext('2d');
        //   img.onload = () => {
        //     // Fill background based on theme for better contrast
        //     ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--bg').trim() || '#ffffff';
        //     ctx.fillRect(0,0,canvas.width, canvas.height);
        //     ctx.drawImage(img, 0, 0, size, size);
        //     canvas.toBlob((blob)=>{
        //       const url = URL.createObjectURL(blob);
        //       const a = document.createElement('a');
        //       a.href = url; a.download = 'novel-wave-tech-logo.png';
        //       document.body.appendChild(a); a.click(); a.remove();
        //       URL.revokeObjectURL(url);
        //     }, 'image/png');
        //   };
        //   img.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(data);
        // });


        const loginForm = document.getElementById('loginForm');
        const statusMessage = document.getElementById('statusMessageDisplay');

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const CaptchaCode = document.getElementById('CaptchaCode').value;
            const Id = document.getElementById('Id').value;

            try {
                const captchaResponse = await fetch(`/Home/GetCaptcha?CaptchaCode=${CaptchaCode}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (captchaResponse.ok) {
                    const loginResponse = await fetch('/Home/LoginPost', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password, CaptchaCode, Id })
                    });

                    if (loginResponse.ok) {
                        const data = await loginResponse.json();
                        statusMessage.innerHTML = '<div class="alert alert-success">Login successful! Redirecting...</div>';
                        //setTimeout(() => window.location.href = '/Home/Index', 1000);
                        window.location.href = '/Home/Index'
                    } else {
                        const err = await loginResponse.json();
                        window.location.reload();
                        statusMessage.innerHTML = `<div class="alert alert-danger">${err.message || 'Invalid credentials. Please try again.'}</div>`;
                        loadCaptcha();
                    }
                } else {
                    const err = await captchaResponse.json();
                    window.location.reload();
                    statusMessage.innerHTML = `<div class="alert alert-danger">${err.message || 'Please enter the correct Captcha.'}</div>`;
                    loadCaptcha();
                }
            } catch (err) {
                console.error(err);
                window.location.reload();
                statusMessage.innerHTML = '<div class="alert alert-danger">An error occurred. Please try again.</div>';
            }
        });

        async function loadCaptcha() {
            try {
                const response = await fetch('/Home/Captcha');
                const blob = await response.blob();
                const idHeader = response.headers.get("Content-Disposition");
                const id = idHeader?.match(/filename="?(.+?)"?$/)?.[1] || '';
                const imageUrl = URL.createObjectURL(blob);
                document.getElementById("img-captcha").src = imageUrl;
                document.getElementById("Id").value = id;
            } catch (err) {
                console.error('Captcha load failed:', err);
                statusMessage.innerHTML = '<div class="alert alert-warning">Could not load captcha. Please refresh the page.</div>';
            }
        }

        document.getElementById('captchaRefresh').addEventListener('click', loadCaptcha);
        document.getElementById('img-captcha').addEventListener('click', loadCaptcha);
    </script>
</body>
</html>
